name: CI — Tests → Allure → Pages → Email

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test-and-publish:
    runs-on: ubuntu-latest

    environment:
      name: github-pages

    steps:

      # STEP 1: Checkout source
      - name: Checkout repository
        uses: actions/checkout@v4

      # STEP 2: Setup Java
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: zulu
          java-version: '17'

      # STEP 3: Cache Maven
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: maven-${{ runner.os }}

      # STEP 4: Run tests
      - name: Run Maven tests
        run: mvn clean test
        continue-on-error: true

      # STEP 5: Verify results folder
      - name: Check allure results
        run: |
          if [ -d target/allure-results ]; then
            echo "Allure results found"
            ls -la target/allure-results
          else
            echo "Creating empty allure-results"
            mkdir -p target/allure-results
          fi

      # STEP 6: Install Allure CLI
      - name: Install Allure CLI
        run: |
          curl -Ls -o allure.tgz https://github.com/allure-framework/allure2/releases/download/2.24.1/allure-2.24.1.tgz
          sudo tar -zxvf allure.tgz -C /opt/
          sudo ln -sf /opt/allure-2.24.1/bin/allure /usr/bin/allure
          allure --version

      # STEP 7: Generate report safely
      - name: Generate Allure report
        run: |
          mkdir -p allure-report
          allure generate target/allure-results --clean -o allure-report || true

          # ensure report exists
          if [ ! -f allure-report/index.html ]; then
            echo "Creating fallback report"
            echo "<html><body><h2>No Allure results found</h2></body></html>" > allure-report/index.html
          fi

      # STEP 8: Upload to GitHub Pages
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: allure-report

      # STEP 9: Deploy Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # STEP 10: Send Email
      - name: Send email with report link
        if: always()
        env:
          MAIL_CONNECTION: ${{ secrets.MAIL_CONNECTION }}
          PAGE_URL: ${{ steps.deployment.outputs.page_url }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |

          python3 <<EOF

          import os, smtplib, ssl
          from urllib.parse import urlparse
          from email.message import EmailMessage

          conn = os.getenv("MAIL_CONNECTION")

          if not conn:
              print("MAIL_CONNECTION missing")
              exit(0)

          parsed = urlparse(conn)

          username = parsed.username
          password = parsed.password
          host = parsed.hostname
          port = parsed.port or 587

          page_url = os.getenv("PAGE_URL")

          msg = EmailMessage()

          msg['Subject'] = "Automation Allure Report"
          msg['From'] = username
          msg['To'] = username

          msg.add_alternative(f'''
          <h2>Allure Report Ready</h2>
          <p><a href="{page_url}">CLICK HERE TO VIEW REPORT</a></p>
          <br>
          <p>GitHub Run:</p>
          <a href="https://github.com/{os.getenv("REPO")}/actions/runs/{os.getenv("RUN_ID")}">
          View Workflow Run
          </a>
          ''', subtype='html')

          context = ssl.create_default_context()

          with smtplib.SMTP(host, port) as server:
              server.starttls(context=context)
              server.login(username, password)
              server.send_message(msg)

          print("EMAIL SENT SUCCESSFULLY")

          EOF
