name: CI — Tests → Allure → Pages → Email

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-and-publish:
    name: Run tests, generate Allure, publish to Pages, email link
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # Checkout source code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Setup Java
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: zulu
          java-version: '17'

      # Cache Maven dependencies
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # Run tests
      - name: Run Maven Tests
        run: mvn -B clean test

      # Verify Allure results folder
      - name: Verify Allure results
        if: always()
        run: |
          echo "Checking Allure results..."
          ls -la target/allure-results || echo "No Allure results found"

      # Checkout gh-pages branch for history (if exists)
      - name: Load previous Allure history
        if: always()
        continue-on-error: true
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      # Build Allure report
      - name: Build Allure Report
        if: always()
        uses: simple-elf/allure-report-action@v1.7
        with:
          gh_pages: gh-pages
          allure_results: target/allure-results
          allure_history: allure-history

      # Upload report as Pages artifact
      - name: Upload Pages artifact
        if: always()
        uses: actions/upload-pages-artifact@v1
        with:
          path: allure-history

      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        if: always()
        uses: actions/deploy-pages@v4

      # Send Email with clickable link
      - name: Send email with report link
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          connection_url: ${{ secrets.MAIL_CONNECTION }}
          subject: "Allure Report - ${{ github.repository }} (Run #${{ github.run_number }})"
          to: your-email@gmail.com
          from: "CI Automation <your-email@gmail.com>"
          html_body: |
            <h2>Automation Test Execution Completed</h2>
            <p><strong>Repository:</strong> ${{ github.repository }}</p>
            <p><strong>Branch:</strong> ${{ github.ref_name }}</p>
            <p><strong>Run Number:</strong> ${{ github.run_number }}</p>
            <hr>
            <p>Click below to view the Allure Report:</p>
            <p>
              <a href="${{ steps.deployment.outputs.page_url }}" 
                 style="padding:10px 20px;background:#0366d6;color:white;text-decoration:none;border-radius:5px;">
                 View Allure Report
              </a>
            </p>
            <br>
            <p>View GitHub Run:</p>
            <p>
              <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">
              Open Workflow Run
              </a>
            </p>
            <br>
            <p>Regards,<br>CI Automation</p>
